<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini DuckDuckGo Browser</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />

  <!-- iOS PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="DuckMini" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />

  <style>
    :root {
      --bg: #f7f7f8;
      --accent: #1a73e8;
    }
    html, body {
      margin: 0;
      padding: 0;
      height: calc(var(--vh, 1vh) * 100);
      background: var(--bg);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      overflow: hidden;
    }
    header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: var(--bg);
      box-shadow: 0 1px 0 rgba(0,0,0,0.06);
      height: 56px;
      box-sizing: border-box;
    }
    button {
      border: 0;
      background: transparent;
      padding: 6px;
      border-radius: 6px;
    }
    .btn {
      cursor: pointer;
    }
    input[type="search"], select, input[type="number"] {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 14px;
    }
    .controls {
      display: flex;
      gap: 6px;
      width: 100%;
      align-items: center;
    }
    #frameWrap {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      top: 56px;
      background: white;
      height: calc(var(--vh, 1vh) * 100 - 56px);
    }
    iframe {
      width: 100%;
      height: 100%;
      border: 0;
      background: white;
    }
    .settings {
      padding: 10px;
      background: #fff;
      border-top: 1px solid #eee;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    label {
      font-size: 13px;
      display: flex;
      flex-direction: column;
    }
    small.gray, span.gray {
      color: #666;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <header>
    <button id="back" title="Zur√ºck" class="btn">‚óÄ</button>
    <button id="forward" title="Vor" class="btn">‚ñ∂</button>

    <div class="controls" style="flex:1">
      <input id="q" type="search" placeholder="DuckDuckGo durchsuchen‚Ä¶" autocomplete="off" autocapitalize="off" autocorrect="off" />
      <button id="searchBtn" class="btn" title="Suchen">üîç</button>
    </div>

    <button id="settingsBtn" class="btn" title="Einstellungen">‚öôÔ∏è</button>
  </header>

  <div id="frameWrap">
    <iframe id="pane" srcdoc="<p style='font-family:system-ui;padding:20px'>Starte eine Suche oben‚Ä¶</p>"></iframe>
  </div>

  <div id="settingsPanel" class="settings" style="display:none">
    <label><input id="enabled" type="checkbox" checked> Tipp-Simulation</label>
    <label>
      <span class="gray">Pause (ms)</span>
      <input id="startDelay" type="number" min="0" value="450" style="width:80px">
    </label>
    <label>
      <span class="gray">Min (ms)</span>
      <input id="minInterval" type="number" min="5" value="25" style="width:70px">
    </label>
    <label>
      <span class="gray">Max (ms)</span>
      <input id="maxInterval" type="number" min="5" value="160" style="width:70px">
    </label>

    <!-- DuckDuckGo-Einstellungen -->
    <label>
      <span class="gray">Sprache</span>
      <select id="lang">
        <option value="">Standard</option>
        <option value="de-de">Deutsch</option>
        <option value="en-us">Englisch (US)</option>
        <option value="fr-fr">Franz√∂sisch</option>
        <option value="es-es">Spanisch</option>
      </select>
    </label>
    <label>
      <span class="gray">Dark Mode</span>
      <select id="darkMode">
        <option value="">Standard</option>
        <option value="1">An</option>
        <option value="-1">Aus</option>
      </select>
    </label>
    <label>
      <span class="gray">SafeSearch</span>
      <select id="safeSearch">
        <option value="">Standard</option>
        <option value="1">Moderat</option>
        <option value="-1">Aus</option>
      </select>
    </label>

    <small class="gray" style="margin-left:auto">DuckDuckGo wird im Frame geladen, falls erlaubt.</small>
  </div>

  <script>
  const prefs = {
    enabled: true,
    startDelay: 450,
    minInterval: 25,
    maxInterval: 160,
    lang: '',
    darkMode: '',
    safeSearch: ''
  };

  const q = document.getElementById('q');
  const searchBtn = document.getElementById('searchBtn');
  const pane = document.getElementById('pane');
  const back = document.getElementById('back');
  const forward = document.getElementById('forward');
  const settingsBtn = document.getElementById('settingsBtn');
  const settingsPanel = document.getElementById('settingsPanel');
  const enabledEl = document.getElementById('enabled');
  const startDelayEl = document.getElementById('startDelay');
  const minIntervalEl = document.getElementById('minInterval');
  const maxIntervalEl = document.getElementById('maxInterval');
  const langEl = document.getElementById('lang');
  const darkModeEl = document.getElementById('darkMode');
  const safeSearchEl = document.getElementById('safeSearch');

  try {
    const saved = JSON.parse(localStorage.getItem('duckmini_prefs')||'{}');
    Object.assign(prefs, saved);
  } catch(e){}

  enabledEl.checked = prefs.enabled;
  startDelayEl.value = prefs.startDelay;
  minIntervalEl.value = prefs.minInterval;
  maxIntervalEl.value = prefs.maxInterval;
  langEl.value = prefs.lang;
  darkModeEl.value = prefs.darkMode;
  safeSearchEl.value = prefs.safeSearch;

  [enabledEl,startDelayEl,minIntervalEl,maxIntervalEl,
   langEl,darkModeEl,safeSearchEl].forEach(el=>{
    el.addEventListener('change',()=>{
      prefs.enabled = !!enabledEl.checked;
      prefs.startDelay = Math.max(0, Number(startDelayEl.value)||0);
      prefs.minInterval = Math.max(1, Number(minIntervalEl.value)||5);
      prefs.maxInterval = Math.max(1, Number(maxIntervalEl.value)||1000);
      prefs.lang = langEl.value;
      prefs.darkMode = darkModeEl.value;
      prefs.safeSearch = safeSearchEl.value;
      if (prefs.minInterval > prefs.maxInterval) {
        prefs.minInterval = prefs.maxInterval;
        minIntervalEl.value = prefs.minInterval;
      }
      localStorage.setItem('duckmini_prefs', JSON.stringify(prefs));
    });
  });

  settingsBtn.addEventListener('click', () => {
    settingsPanel.style.display = settingsPanel.style.display === 'none' ? 'flex' : 'none';
  });

  back.addEventListener('click', () => {
    try {
      pane.contentWindow.history.back();
    } catch (e) {
      history.back();
    }
  });
  forward.addEventListener('click', () => {
    try {
      pane.contentWindow.history.forward();
    } catch (e) {
      history.forward();
    }
  });

  function ddgUrl(query) {
    const qenc = encodeURIComponent(query || '');
    let url = `https://duckduckgo.com/?q=${qenc}&t=hm`;
    if (prefs.lang) url += `&kl=${encodeURIComponent(prefs.lang)}`;
    if (prefs.darkMode) url += `&k1=${encodeURIComponent(prefs.darkMode)}`;
    if (prefs.safeSearch) url += `&kp=${encodeURIComponent(prefs.safeSearch)}`;
    return url;
  }

  function loadInPane(url) {
    let loaded = false;
    pane.src = url;
    const to = setTimeout(() => {
      if (!loaded) {
        window.location.href = url;
      }
    }, 1800);

    pane.onload = () => {
      loaded = true;
      clearTimeout(to);
    };
  }

  function doSearch(query) {
    if (!query) return;
    const url = ddgUrl(query);
    loadInPane(url);
  }

  searchBtn.addEventListener('click', () => doSearch(q.value));
  q.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      doSearch(q.value);
    }
  });

  (function typingSim() {
    let typingTimer;

    function dispatchInputEvent(el) {
      const ev = new Event('input', { bubbles: true, cancelable: true });
      el.dispatchEvent(ev);
    }

    async function simulateTyping(target, finalText) {
      if (!prefs.enabled) return;
      target.focus();
      target.value = '';
      dispatchInputEvent(target);

      for (let i = 0; i < finalText.length; i++) {
        const delay = prefs.minInterval + Math.random() * (prefs.maxInterval - prefs.minInterval);
        await new Promise(r => setTimeout(r, delay));
        target.value += finalText[i];
        dispatchInputEvent(target);
      }
    }

    q.addEventListener('focus', () => {
      clearTimeout(typingTimer);
    });

    q.addEventListener('blur', () => {
      if (!prefs.enabled) return;
      const val = q.value.trim();
      if (!val) return;
      typingTimer = setTimeout(() => simulateTyping(q, val), prefs.startDelay);
    });
  })();

  function setVh() {
    document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
  }
  window.addEventListener('resize', setVh);
  window.addEventListener('orientationchange', setVh);
  setVh();
  </script>
</body>
</html>
