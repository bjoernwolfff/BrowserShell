<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HopperBrowser</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="DuckMini" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />

  <style>
    :root {
      --bg-light: #ffffff;
      --fg-light: #121212;
      --bg-dark: #121212;
      --fg-dark: #e0e0e0;
      --accent: #1a73e8;
      --border: #333;
    }
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background: var(--bg-dark);
      color: var(--fg-dark);
    }
    body.light {
      background: var(--bg-light);
      color: var(--fg-light);
    }
    header {
      display: flex; align-items: center; gap: 8px;
      padding: 8px; background: inherit; color: inherit;
      border-bottom: 1px solid var(--border);
      height: 56px; box-sizing: border-box;
      flex-shrink: 0;
    }
    button {
      border: 0; background: transparent; padding: 6px;
      border-radius: 6px; cursor: pointer; color: inherit;
      font-size: 18px;
      user-select: none;
    }
    button:disabled {
      opacity: 0.4;
      cursor: default;
    }
    input[type="search"], select {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 14px;
      background: #1e1e1e;
      color: var(--fg-dark);
      flex-grow: 1;
      outline-offset: 2px;
    }
    body.light input[type="search"], body.light select {
      background: #f9f9f9;
      color: var(--fg-light);
      border-color: #aaa;
    }
    .settings {
      position: absolute; top: 56px; left: 0; right: 0;
      background: #1e1e1e; border-bottom: 1px solid var(--border);
      display: none; flex-wrap: wrap; gap: 8px; padding: 8px;
      z-index: 1000; color: var(--fg-dark);
    }
    body.light .settings {
      background: #f9f9f9;
      color: var(--fg-light);
      border-color: #aaa;
    }
    label {
      font-size: 12px; display: flex; flex-direction: column;
      min-width: 120px;
    }
    iframe {
      flex-grow: 1;
      width: 100%;
      border: none;
      background: white;
    }
  </style>
</head>
<body>
<header>
  <button id="back" disabled title="Zur√ºck">‚óÄ</button>
  <button id="forward" disabled title="Vorw√§rts">‚ñ∂</button>
  <input id="q" type="search" placeholder="Ecosia durchsuchen‚Ä¶" autocomplete="off" />
  <button id="searchBtn" title="Suchen">üîç</button>
  <button id="settingsBtn" title="Einstellungen">‚öôÔ∏è</button>
</header>

<div id="settingsPanel" class="settings">
  <label>Sprache/Region
    <select id="lang">
      <option value="">Standard</option>
      <option value="de-de">Deutsch</option>
      <option value="en-us">Englisch (US)</option>
      <option value="fr-fr">Franz√∂sisch</option>
      <option value="es-es">Spanisch</option>
      <option value="it-it">Italienisch</option>
      <option value="nl-nl">Niederl√§ndisch</option>
    </select>
  </label>
  <label>Dark Mode
    <select id="darkMode">
      <option value="">Standard</option>
      <option value="1">An</option>
      <option value="-1">Aus</option>
    </select>
  </label>
  <label>SafeSearch
    <select id="safeSearch">
      <option value="">Standard</option>
      <option value="1">Moderat</option>
      <option value="-1">Aus</option>
    </select>
  </label>
  <label>Autovervollst√§ndigung
    <select id="autoComplete">
      <option value="">Standard</option>
      <option value="1">An</option>
      <option value="-1">Aus</option>
    </select>
  </label>
  <label>Suchvorschl√§ge
    <select id="suggestions">
      <option value="">Standard</option>
      <option value="1">An</option>
      <option value="-1">Aus</option>
    </select>
  </label>
  <label>Ergebnissprache
    <select id="resultLang">
      <option value="">Standard</option>
      <option value="de-de">Deutsch</option>
      <option value="en-us">Englisch</option>
      <option value="fr-fr">Franz√∂sisch</option>
    </select>
  </label>
  <label>Layout
    <select id="layout">
      <option value="">Standard</option>
      <option value="d">Desktop</option>
      <option value="h">High Contrast</option>
      <option value="m">Mobile</option>
    </select>
  </label>
  <label>Neuer Tab
    <select id="newTab">
      <option value="">Standard (Neues Fenster)</option>
      <option value="1">Ja (Neuer Tab)</option>
      <option value="-1">Nein (Neues Fenster)</option>
    </select>
  </label>
  <label>HTTPS only
    <select id="httpsOnly">
      <option value="">Standard</option>
      <option value="1">Ja</option>
      <option value="-1">Nein</option>
    </select>
  </label>
</div>

<iframe id="searchFrame" src=""></iframe>

<script>
const prefs = {
  lang: '', darkMode: '1', safeSearch: '',
  autoComplete: '', suggestions: '',
  resultLang: '', layout: '', newTab: '',
  httpsOnly: ''
};
const q = document.getElementById('q');
const settingsPanel = document.getElementById('settingsPanel');
const iframe = document.getElementById('searchFrame');
const backBtn = document.getElementById('back');
const forwardBtn = document.getElementById('forward');

// Felder referenzieren
const fields = {
  lang: document.getElementById('lang'),
  darkMode: document.getElementById('darkMode'),
  safeSearch: document.getElementById('safeSearch'),
  autoComplete: document.getElementById('autoComplete'),
  suggestions: document.getElementById('suggestions'),
  resultLang: document.getElementById('resultLang'),
  layout: document.getElementById('layout'),
  newTab: document.getElementById('newTab'),
  httpsOnly: document.getElementById('httpsOnly')
};

// Lade gespeicherte Einstellungen
try {
  const saved = JSON.parse(localStorage.getItem('duckmini_prefs')||'{}');
  Object.assign(prefs, saved);
} catch(e) {}

// Setze Werte in die Felder und Listener
for (const key in fields) {
  fields[key].value = prefs[key] || '';
  fields[key].addEventListener('change', () => {
    prefs[key] = fields[key].value;
    localStorage.setItem('duckmini_prefs', JSON.stringify(prefs));
    applyDarkMode();
  });
}

// Dark Mode anwenden auf Body-Klasse
function applyDarkMode() {
  if(prefs.darkMode === '1') {
    document.body.classList.remove('light');
  } else if (prefs.darkMode === '-1') {
    document.body.classList.add('light');
  } else {
    // Standard, hier Dark (wie original)
    document.body.classList.remove('light');
  }
}
applyDarkMode();

function ecosiaUrl(query) {
  const qenc = encodeURIComponent(query || '');
  let url = `https://www.ecosia.org/search?q=${qenc}`;

  // Ecosia unterst√ºtzt keine params wie SafeSearch, Layout, Language per URL offiziell
  // Hier k√∂nnte man weitere Parametrisierung erg√§nzen, falls ben√∂tigt

  return url;
}

function doSearch(query) {
  if (!query) return;

  if (prefs.newTab === '1') {
    // Im neuen Tab √∂ffnen
    window.open(ecosiaUrl(query), '_blank');
  } else {
    // Im iframe laden
    iframe.src = ecosiaUrl(query);
  }
  updateButtons();
}

// History Navigation im iframe (eingeschr√§nkt durch Browser-Security)
backBtn.addEventListener('click', () => {
  try {
    iframe.contentWindow.history.back();
  } catch {}
  updateButtons();
});
forwardBtn.addEventListener('click', () => {
  try {
    iframe.contentWindow.history.forward();
  } catch {}
  updateButtons();
});

// Update Buttons Zustand (aktiv / deaktiviert)
function updateButtons() {
  try {
    backBtn.disabled = !(iframe.contentWindow.history.length > 1);
    // Forward wird hier schwierig zu tracken, daher immer enabled
    forwardBtn.disabled = false;
  } catch {
    backBtn.disabled = true;
    forwardBtn.disabled = true;
  }
}

// Search-Button und Enter im Suchfeld
document.getElementById('searchBtn').addEventListener('click', () => doSearch(q.value));
q.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    e.preventDefault();
    doSearch(q.value);
  }
});

// Settings-Panel toggeln
document.getElementById('settingsBtn').addEventListener('click', () => {
  settingsPanel.style.display = (settingsPanel.style.display === 'flex') ? 'none' : 'flex';
});

// Initial Buttons Zustand
updateButtons();

</script>
</body>
</html>
